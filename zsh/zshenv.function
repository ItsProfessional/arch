# non-interactive shell invoked functions go here

# terminal title
function printtermtitle() {

	# lazy load __git_ps1
	if ! type __git_ps1 > /dev/null 2>&1; then
		if [ -f /usr/share/git/completion/git-prompt.sh ]; then
			GIT_PS1_SHOWDIRTYSTATE="true"
			GIT_PS1_SHOWSTASHSTATE="true"
			GIT_PS1_SHOWUPSTREAM="auto"
			. /usr/share/git/completion/git-prompt.sh
		else
			function __git_ps1() { : }
		fi
	fi

	if [ -n "${SSH_CONNECTION}" -o "${USER}" = "root" ]; then
		print -n "${HOST}  "
	fi

	# don't include __git_ps1 in the print lest it be prompt substituted
	print -Pn "%~ "
	__git_ps1
}

# print TERM from the tmux environment
function underlyingterm() {
	local UNDERLYING="${TERM}"
	if [ -n "${TMUX}" ]; then
		local TMT=$(tmux show-environment TERM 2>/dev/null)
		if [ $? -eq 0 ]; then
			UNDERLYING="${TMT/TERM=/}"
		fi
	fi
	printf "${UNDERLYING}"
}

# print git ps1, current branch, upstream URL
function gs() {
	git_ps1=$(__git_ps1 2>/dev/null)
	branch_local=$(git rev-parse --abbrev-ref HEAD)
	branch_remote=$(git rev-parse --abbrev-ref --symbolic-full-name @{upstream})
	url=$(git remote get-url ${branch_remote/\/*/})
	user=${${(S)url/*:/}/\/*/}

	print "${git_ps1}\n${branch_local}\n${branch_remote}\n${url}\n${user}"
}

# set branch upstream to $1
function gu {
	if [ ${#} -ne 1 ]; then
		echo "Usage: gu <name>" >&2
		return 1
	fi
	branch_local=$(git rev-parse --abbrev-ref HEAD)
	git branch --set-upstream-to="${1}/${branch_local}" "${branch_local}"
}

# search parents / .config
function stylua {
	local ARGS=""

	if [ -z "${@[(r)--search-parent-directories]}" -a -z "${@[(r)-s]}" ]; then
		ARGS="--search-parent-directories"
		$(whence -p stylua)  "${@}"
	fi

	$(whence -p stylua) "${ARGS}" "${@}"
}

function remote_env_setup() {
	TERM_PREV="${TERM}"
	TERM=$(underlyingterm)
	if [ -n "${TMUX}" ]; then
		# prefix2 C-b still available
		tmux set prefix None
	fi
}

function remote_env_teardown() {
	if [ -n "${TMUX}" ]; then
		tmux set -u prefix
	fi
	TERM="${TERM_PREV}"
	unset TERM_PREV
}

function remote_env_ssh() {
	remote_env_setup
	$(whence -p ssh) "${@}"
	read
	print -n '\Ec'
	remote_env_teardown
}

function make() {
	$(whence -p make) "${CC+CC=${CC}}" "${CXX+CXX=${CXX}}" "${@}"
}
