#!/bin/zsh

TEMPLATE="${XDG_CONFIG_HOME}/nvim/nvt-dev-template.lua"
ROOT="/tmp/nvt-dev"
INIT="${ROOT}/nvt-dev.lua"
PACKPATH="${ROOT}/site"

function edit() {
	cd "${ROOT}"
	vi "${INIT}"
}

function clean() {
	rm -rf "${ROOT}"
}

function init() {

	# pick source
	if [ -z "${1}" ]; then
		USR="dev"
	else
		USR="${1}"
	fi
	SRC="${HOME}/src/nvim-tree.lua/${USR}"

	if [ ! -d "${SRC}" ]; then
		echo "${SRC} inexistent"
		exit 1
	fi

	# create
	clean
	mkdir "${ROOT}"
	cp "${TEMPLATE}" "${INIT}"

	# nvim-tree plugin path
	sed -i -e "
		s#-- NVIM_TREE_DIR#\"${SRC}\",#
	" "${INIT}"

	# scrape options
	sed -n -e "
		/BEGIN_DEFAULT_OPTS/,/END_DEFAULT_OPTS/{
			/BEGIN_DEFAULT_OPTS/d
			/END_DEFAULT_OPTS/d
			p
		}
	" "${SRC}/lua/nvim-tree.lua" > "${ROOT}/DEFAULT_OPTS.lua"

	sed -i -e "
	"

	# insert options
	sed -i -e "
		/DEFAULT_OPTS/{
			r ${ROOT}/DEFAULT_OPTS.lua
			/DEFAULT_OPTS/d
		}
	" "${INIT}"

	# enable logging
	sed -i -e "
		/log = {/{
			n
			s/enable = false/enable = true/
		}
		s/truncate = false/truncate = true/
		s/dev = false/dev = true/
	" "${INIT}"
}

case "${1}" in
	"edit")
		edit
		;;
	"clear")
		clear
		;;
	"init")
		init "${2}"
		;;
	*)
		nvim -nu "${INIT}" ${@}
		;;
esac

