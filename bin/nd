#!/bin/zsh

INIT="${XDG_DATA_HOME}/nvim/nvt-dev.lua"
PACKPATH="/tmp/nvt-dev/site"

function edit() {
	vi "${INIT}"
}

function clean() {
	rm -rf "${INIT}" "${PACKPATH}"
}

function init() {
	clean

	if [ -z "${1}" ]; then
		USR="dev"
	else
		USR="${1}"
	fi
	SRC="${HOME}/src/nvim-tree.lua/${USR}"

	if [ ! -d "${SRC}" ]; then
		echo "${SRC} inexistent"
		exit 1
	fi

	# disable netrw
	cat << EOF > "${INIT}"
vim.g.loaded_netrw = 1
vim.g.loaded_netrwPlugin = 1
EOF

	# copy up to setup
	grep -B 1000 "MODIFY NVIM-TREE SETTINGS" ${SRC}/.github/ISSUE_TEMPLATE/nvt-min.lua >> "${INIT}"

	# setup call
	cat << EOF >> "${INIT}"
_G.setup = function()
  require("nvim-tree").setup({
EOF

	# default options
	sed -n -e "/BEGIN_DEFAULT_OPTS/,/END_DEFAULT_OPTS/{ /BEGIN_DEFAULT_OPTS/d; /END_DEFAULT_OPTS/d; p; }" "${SRC}/lua/nvim-tree.lua" | sed -e "s/^  /    /" >> "${INIT}"

	# modify plugin directory, enable logging
	sed -i -e "
	s#nvim-tree/nvim-tree.lua#${SRC}#g ;
	s/nvt-min/nvt-dev/g ;

	/log = {/{ n; s/enable = false/enable = true/ } ;
	s/truncate = false/truncate = true/ ;
	s/dev = false/dev = true/ ;
	" "${INIT}"

	# mappings
	cat << EOF >> "${INIT}"
  })

  local nt_api = require("nvim-tree.api")

  vim.keymap.set("n", ";", ":", { noremap = true })
  vim.keymap.set("n", "<space>a", nt_api.tree.open, { noremap = true })
  vim.keymap.set("n", "<space>o", [[ :wincmd p<CR> ]], { noremap = true })
end
EOF
}

case "${1}" in
	"edit")
		edit
		;;
	"clear")
		clear
		;;
	"init")
		init "${2}"
		;;
	*)
		nvim -nu "${INIT}" ${@}
		;;
esac

