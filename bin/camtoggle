#!/bin/sh

# Toggle camera and video for Tenveo webcam.
# Toggling the entire hub is unreliable: pulse doesn't always reconnect.

device_id()
{
	grep -l "${1}" /sys/bus/usb/devices/*/uevent | sort | tail -1 | sed -e 's#^/sys/bus/usb/devices/## ; s#/uevent$##'
}

is_bound()
{
	if [ -d "/sys/bus/usb/drivers/usb/${1}" ]; then
		echo "true"
	else
		echo "false"
	fi
}

device_off()
{
	if [ -d "/sys/bus/usb/devices/${1}" ]; then
		echo "${1}" > /sys/bus/usb/drivers/usb/unbind
	fi
}

device_on()
{
	if [ -d "/sys/bus/usb/devices/${1}" ]; then
		echo "${1}" > /sys/bus/usb/drivers/usb/bind
	fi
}

# Anhui LISTENAI CO.,LTD. Castor
ID_SOUND="$(device_id '27c2/526')"
BOUND_SOUND="$(is_bound ${ID_SOUND})"

# Tenveo Tenveo 4K AI Cam
ID_VIDEO="$(device_id '2aad/1120')"
BOUND_VIDEO="$(is_bound ${ID_VIDEO})"

if [ -z "${ID_SOUND}" -a -z "${ID_VIDEO}" ]; then
	echo "devices unavailable"
	exit
fi

# off if either device is enabled
if [ "${BOUND_SOUND}" = "true" -o "${BOUND_VIDEO}" = "true" ]; then
	echo unbinding
	device_off "${ID_SOUND}"
	device_off "${ID_VIDEO}"
else
	echo binding
	device_on "${ID_SOUND}"
	device_on "${ID_VIDEO}"
fi

