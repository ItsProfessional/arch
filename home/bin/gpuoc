#!/bin/sh

set -e

devicepath="/sys/devices/pci0000:40/0000:40:03.1/0000:43:00.0/0000:44:00.0/0000:45:00.0"

#
# sys level clock voltage
#
# 6.5% increase in clocks > 0
# drop the voltage only on the top level
#
echo "s 0  852  800" > "${devicepath}/pp_od_clk_voltage"
echo "s 1 1057  900" > "${devicepath}/pp_od_clk_voltage"
echo "s 2 1152  950" > "${devicepath}/pp_od_clk_voltage"
echo "s 3 1212 1000" > "${devicepath}/pp_od_clk_voltage"
echo "s 4 1277 1050" > "${devicepath}/pp_od_clk_voltage"
echo "s 5 1492 1100" > "${devicepath}/pp_od_clk_voltage"
echo "s 6 1637 1150" > "${devicepath}/pp_od_clk_voltage"
echo "s 7 1732 1175" > "${devicepath}/pp_od_clk_voltage"

#
# mem level clock voltage
#
#       0  167  800
echo "m 0  167  800" > "${devicepath}/pp_od_clk_voltage"
#       1  500  800
echo "m 1  500  800" > "${devicepath}/pp_od_clk_voltage"
#       2  800  950
echo "m 2  800  950" > "${devicepath}/pp_od_clk_voltage"
#       3  945 1100
echo "m 3 1100 1050" > "${devicepath}/pp_od_clk_voltage"

#
# commmit
#
echo "c" > "${devicepath}/pp_od_clk_voltage"

#
# without being encouraged, the gpu won't move to higher states
#
echo "high" > "${devicepath}/power_dpm_force_performance_level"

#
# max power is set to +50% i.e. 240W to 360W
#
cat "${devicepath}/hwmon/hwmon0/power1_cap_max" > "${devicepath}/hwmon/hwmon0/power1_cap"

gpumonitor -v
