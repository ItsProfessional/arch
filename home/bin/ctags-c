#!/bin/sh

# Generates tags for a C/C++ project and its includes.
# 
# Identifies all source and headers by invoking `cc -M` with all the supplied arguments,
# then passes the results to ctags for processing.
#
# Invoke from a makefile e.g.
#  ctags:
#  	generate-ctags-c $(SRC) $(CPPFLAGS)
#
# Or directly e.g.
#  generate-ctags-c *c *h *cpp -I /usr/include/libevdev-1.0

function usage() {
	cat << END_USAGE
From a Makefile:
	ctags:
		generate-ctags-c \$(SRC) \$(INC)
or direct:
	generate-ctags-c *c *h *cpp -I /usr/include/libevdev-1.0
END_USAGE
}

if [ $# -eq 0 ]; then
	usage
	exit 1
fi

# https://www.topbug.net/blog/2012/03/17/generate-ctags-files-for-c-slash-c-plus-plus-source-files-and-all-of-their-included-header-files/
CMD_DEPS="cc -M $@"
echo ${CMD_DEPS}
${CMD_DEPS} \
	| sed -e 's/[\\ ]/\n/g'  \
	| sed -e '/^$/d' \
	| sed -e '/\.o:[ \t]*$/d' \
	> /tmp/ctags-c.files

# only a few system headers will be C
OPTS="--languages=C,C++"

# prototypes
OPTS="${OPTS} --c++-kinds=+pl --c-kinds=+pl"

# signatures
OPTS="${OPTS} --fields=+S"

# class qualifiers
OPTS="${OPTS} --extras=+q"

CMD_CTAGS="ctags -L /tmp/ctags-c.files ${OPTS}"

echo "${CMD_CTAGS}"
${CMD_CTAGS}

